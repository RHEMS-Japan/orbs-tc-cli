description: >
  Configure TCCLI.
parameters:
  tc-secret-id:
    type: env_var_name
    default: "TC_SECRET_ID"
    description: "TencentCloud API secretId."
  tc-secret-key:
    type: env_var_name
    default: "TC_SECRET_KEY"
    description: "TencentCloud API secretKey."
  tc-region:
    type: env_var_name
    default: "TC_REGION"
    description: "TencentCloud region to operate in."
  access-domain:
    type: env_var_name
    default: "TCR_ACCESS_DOMAIN"
    description: "Access Domain of Tencent Container Registry."
  registry-id:
    type: env_var_name
    default: "TCR_REGISTRY_ID"
    description: "Instance ID of Tencent Container Registry."
steps:
  - setup-tccli:
      tc-secret-id: << parameters.tc-secret-id >>
      tc-secret-key: << parameters.tc-secret-key >>
      tc-region: << parameters.tc-region >>
  - jq/install
  - run:
      name: create temporary instance token
      command: |
        TCR_REGISTRY_ID=$(eval echo "\$<< parameters.registry-id >>")
        tccli tcr CreateInstanceToken --cli-unfold-argument --RegistryId ${TCR_REGISTRY_ID} --TokenType temp > token.json
  - run:
      name: docker login
      command: |
        username=$(cat token.json | jq ".Username")
        password=$(cat token.json | jq ".Token")
        TCR_ACCOUNT_URL=$(eval echo "\$<< parameters.access-domain >>")
        docker login ${TCR_ACCOUNT_URL} --username ${username} --password ${password}
